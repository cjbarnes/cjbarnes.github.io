---
title: better Gift Aid calculator, part 1
languages:
- JavaScript
- jQuery
format: tutorial
---

I wanted to make a better [Gift Aid](//www.gov.uk/donating-to-charity/gift-aid "GOV.UK page about Gift Aid") calculator for UK charity websites---one that's easier to use, more eye-catching, and better explains how Gift Aid actually works. [So I built one](https://www.yorkspace.net/giftaid "University of York's Gift Aid calculator") for the University of York. This tutorial will help you to build one too.
{:.lead}

The second part of this tutorial will cover the thing that makes my Gift Aid calculator distinctive: its **design**. There I will also outline the design flaws of the existing Gift Aid calculators, which led me to work on an alternative. But before we work on the calculator's layout and aesthetics, we first need the basic JavaScript that makes a Gift Aid calculator work. Follow this first part of the tutorial to find out how to do that.

## the basic structure

Our script will need three main functions:

<figure class="code">
{% highlight javascript %}
/**
 * Calculate the amounts claimable and total amounts for a gift at the
 * specified tax rate.
 * @param {Number} initialGift The gross value of the gift in pounds.
 * @param {Number} taxRate     The tax band of the giver (as a percentage).
 * @return {Object} Both initial and calculated values for this gift.
 */
function calculateGiftAid(initialGift, taxRate) { }

/**
 * Perform a Gift Aid calculation and output results to the page.
 * @param {Element} calc The Gift Aid calculator parent element.
 */
function updateGiftAidCalculator(calc) { }

/**
 * On DOM ready, hook up the events that make the Gift Aid calculator work,
 * and set initial values and styling.
 */
function initGiftAidCalculator() { }
{% endhighlight %}
</figure>

The first function, `calculateGiftAid()`, performs a basic Gift Aid calculation and returns a set of amounts. The second, `updateGiftAidCalculator()`, takes the values returned by the first and outputs them to the visible webpage. The third, `initGiftAidCalculator()`, starts everything off when the page loads---it runs an initial Gift Aid calculation on the default gift amount and tax rate, and then begins listening for user input that should trigger a recalculation.

## step 1: the calculation itself

TODO

We need to account for a few subtleties of how Gift Aid works:

1. The official value of Gift Aid to the charity is 20%. However, that's not
   20% of the original gift, it's **20% of the sum of both original gift and Gift Aid**. Which is actually 25%.[^1]
2. For most Gift Aid gifts, the only beneficiary of Gift Aid is the charity.
   The basic rate of 20% tax was paid on the gift, and the charity claims the entire 20% back. However, **higher-rate taxpayers** paid more than 20% tax on the gift so they can claim the rest back themselves. So both charity and taxpayer end up better off, but only if the taxpayer is on the higher rate.
3. In 2015, there are **two higher rates** in the UK---40% and 45%---meaning
   some givers can claim back 20% of their gift and some can claim back 25% (and of course the majority can't claim anything).

TODO

<figure class="code">
{% highlight javascript %}
function calculateGiftAid(initialGift, taxRate) {
    
  /*
   * Convert gift amount into pence for easier (and more accurate) maths. Fall
   * back to 0 if NaN or less than 1p.
   */
  initialGift = parseInt((initialGift * 100), 10) || 0;
  
  // Calculate what the charity gets.
  var charityClaimAmount = initialGift / 4;
  var netGiftReceived = initialGift + charityClaimAmount;
    
{% endhighlight %}
</figure>

TODO

<figure class="code">
{% highlight javascript %}

  var giverClaimAmount = 0;
  
  /*
   * Calculate amount of tax the giver can claim back. Works out to the
   * difference between the total tax paid on the gift and the amount claimed
   * by the charity. Is always 0 unless this is a higher-rate tax payer.
   */
  if (_basicRate < taxRate) {
    var giverClaimAmount = (netGiftReceived * taxRate / 100) - charityClaimAmount;
  }
  var netGiftGiven = initialGift - giverClaimAmount;
    
{% endhighlight %}
</figure>

Now we've calculated everything, we just need to return our results. JavaScript only allows you to return one variable per function, but we have several amounts we need to return. The solution to this is to return an *object* that contains all our results, like this:

<figure class="code">
{% highlight javascript %}

  // Return an object containing all the amounts involved in this gift.
  return {
    // Initial values passed into this function.
    grossGift:       initialGift,
    taxRate:         taxRate,
    // Calculated values.
    charityClaims:   charityClaimAmount,
    giverClaims:     giverClaimAmount,
    netGiftGiven:    netGiftGiven,
    netGiftReceived: netGiftReceived
  };
}
{% endhighlight %}
</figure>

This allows us to pass all our results to our calling function as expected. But there's still one problem with our results: the amounts are all in pence, not pounds, since we multiplied the original gift by 100 to make our maths easier. So we need to convert our pence amounts back into pounds. We'll do this with a simple function called `outputAmount()`:

<figure class="code">
{% highlight javascript %}

  // Return an object containing all the amounts involved in this gift.
  return {
    // Initial values passed into this function.
    grossGift:       outputAmount(initialGift),
    taxRate:         taxRate,
    // Calculated values.
    charityClaims:   outputAmount(charityClaimAmount),
    giverClaims:     outputAmount(giverClaimAmount),
    netGiftGiven:    outputAmount(netGiftGiven),
    netGiftReceived: outputAmount(netGiftReceived)
  };
}

/**
 * Convert monetary values (in pence) into properly formatted pounds-and-pence
 * strings, ready for outputting to the user.
 * @param {Number} pence Amount to output, in pence. Anything after the
 *                       decimal point will be discarded.
 * @return {String} Formatted value (e.g. if pence == 173, return '1.73').
 */
function outputAmount(pence) {
  pence = parseInt(pence, 10) || 0;
  return ((pence / 100).toFixed(2));
}
{% endhighlight %}
</figure>

We now have a working calculator function! It works fine, but it isn't very future proof. What if the Government adjusts tax rates? If the basic rate of tax changes, every bit of maths in this function will need to be reworked.

A better approach would be to store the basic rate in one variable, and then use that variable in every calculation within this function. Then we'd only need to update a single line of code when the basic rate changes. Unfortunately, this makes the maths rather more complicated, but it's worth it:

<figure class="code">
{% highlight javascript %}
function calculateGiftAid(initialGift, taxRate) {
  /*
   * The standard tax rate. Any tax above this threshold that is paid on the
   * gift is claimed back by the giver, not the charity.
   */
  var _basicRate = 20;
  
  /*
   * Convert gift amount into pence for easier (and more accurate) maths. Fall
   * back to 0 if NaN or less than 1p.
   */
  initialGift = parseInt((initialGift * 100), 10) || 0;

  // Calculate what the charity gets.
  var charityClaimAmount = initialGift * _basicRate / (100 - _basicRate);
  var netGiftReceived = initialGift + charityClaimAmount;

  var giverClaimAmount = 0;
  /*
   * Calculate amount of tax the giver can claim back. Works out to the
   * difference between the total tax paid on the gift and the amount claimed
   * by the charity. Is always 0 unless this is a higher-rate tax payer.
   */
  if (_basicRate < taxRate) {
    var giverClaimAmount = (netGiftReceived * taxRate / 100) - charityClaimAmount;
  }
  var netGiftGiven = initialGift - giverClaimAmount;

  // Return an object containing all the amounts involved in this gift.
  return {
    // Initial values passed into this function.
    grossGift:       outputAmount(initialGift),
    taxRate:         taxRate,
    // Calculated values.
    charityClaims:   outputAmount(charityClaimAmount),
    giverClaims:     outputAmount(giverClaimAmount),
    netGiftGiven:    outputAmount(netGiftGiven),
    netGiftReceived: outputAmount(netGiftReceived)
  };
}
{% endhighlight %}
</figure>

Our calculation function is now complete. In the final version (in the tutorial files) there's some additional niceties, including more robust validation. Download here: [gift-aid-calculator.js](https://github.com/cjbarnes/gift-aid-calculator/blob/master/src/gift-aid-calculator.js "the finished script file on GitHub").

## step 2: updating the DOM

TODO

We want our Gift Aid calculator JavaScript to be as design-agnostic as possible, so we can be flexible in how we mark up and style it in part two of this tutorial. So we'll use a set of HTML classes, each prefixed with `.js-`, to mark the elements that should be updated by our script. Specifically, we'll use these classes:

| ------------------------------ | ---------------------------------------- |
| Class                          | Description                              |
| ============================== | ======================================== |
| `.js-giftaid-calculator`       | Container for all elements in a single   |
|                                | Gift Aid calculator                      |
| ------------------------------ | ---------------------------------------- |
| `.js-input-gift`               | `<input>` that the user types their gift |
|                                | amount into                              |
| ------------------------------ | ---------------------------------------- |
| `.js-input-taxrate`            | `<select>` with a list of tax rates for  |
|                                | the user to choose from                  |
| ------------------------------ | ---------------------------------------- |
| `.js-output-gross-gift`        | The original gift amount (same as        |
|                                | `.js-input-gift`, but not user-editable) |
| ------------------------------ | ---------------------------------------- |
| `.js-output-giver-claims`      | How much tax the giver is entitled to    |
|                                | claim back                               |
| ------------------------------ | ---------------------------------------- |
| `.js-output-charity-claims`    | How much Gift Aid the charity can claim  |
|                                | in addition to the gross gift            |
| ------------------------------ | ---------------------------------------- |
| `.js-output-net-gift-given`    | The real cost of the gift to the giver,  |
|                                | once the amount they can claim has been  |
|                                | subtracted                               |
| ------------------------------ | ---------------------------------------- |
| `.js-output-net-gift-received` | The real amount the charity gets from    |
|                                | the gift, once Gift Aid has been added   |
| ------------------------------ | ---------------------------------------- |

TODO

## step 3: initializing everything

TODO

[^1]: Don't read this footnote if algebra gives you nightmares. But for the mathematically inclined among you, here's why Gift Aid is officially 20% but really 25%.
    
    The rule is that Gift Aid is worth 20% (i.e. a fifth) of the **whole gift**---that is, both the gift and its additional Gift Aid. Which means that Gift Aid appears on both sides of our equation:
    
    ***Gift Aid* = (*Gift* + *Gift Aid*) ÷ 5**
    
    So to work out the Gift Aid for any gift amount, we must first (in the words of a thousand GCSE Maths textbooks) *simplify*:
    
    1: *multiply each side by 5:*
    
    ***Gift Aid* × 5 = *Gift* + *Gift Aid***
    
    2: *take one Gift Aid from each side:*
    
    ***Gift Aid* × 4 = *Gift***
    
    3: *divide each side by 4:*
    
    ***Gift Aid* = *Gift* ÷ 4**
    
    Therefore the Gift Aid amount is one-fourth of the original gift---or 25%.
